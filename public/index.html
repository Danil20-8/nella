<style>
    .clickable:hover {
        background-color: yellow;
    }

    .clicked {
        background-color: aqua;
    }

    .clickable.clicked:hover {
        background-color: green;
    }
</style>

<button onclick="buttonClick.call(this, event)">
    Push
</button>

<button onclick="incrementClick.call(this, event)">
    Increment
</button>

<div onclick="console.log('Hey!')">Click me</div>
<logger></logger>
<logger></logger>
<logger></logger>

<div id="log"></div>

<link id="logger" rel="text/html" href="logger.html">
</link>
<script>
    let error = console.error.bind(console);
    console.error = (m) => {
        document.querySelector("#log").innerHTML = m;
        error(m);
    }
</script>
<script src="index.js"></script>
<script>

    class ContentPage {
        context;
        element;

        searchValue;
        constructor(context) {
            this.context = context;

            this.element = body(
                searchComponent({
                    value: () => this.searchValue || "",
                    onchange: (e) => {
                        this.searchValue = e.target.value;

                        this.update();
                    },
                    suggestions: ["wall", "stay", "love", "feel", "be", "do"]
                }),
                div({},
                    listComponent({
                        data: ["item 1", "item 2"],
                        createElement: (data) => {
                            return div({
                                innerText: data
                            });
                        }
                    }, div({

                    }))
                )
            );
        }
        update() {
            this.element.update();
        }
    }
    function contentPage(context) {
        return new ContentPage(context);
    }

    function itemPage(context) {
        let page = body(
            div({
                style: "background: red; width: 10px; height: 10px;"
            }),
            select({
                style: "width: 200px;",
                value: 3,
                options: [1, 2, 3, 4, 5],
                onchange: (e) => update(page)
            })
        );

        return page;
    }

    class MainContext {
        items;

        buttonClicked;
        tags;
        count;
        leftright;
        constructor() {
            this.items = ["1", "2", "3"];
            this.buttonClicked = false;
            this.count = 0;
            this.tags = "";
            this.leftright = [{ value: 1, side: false }, { value: 2, side: false }, { value: 3, side: false }, { value: 4, side: true }]
        }
    }
    class MainApp {
        parent;
        context;
        element;
        constructor(parent) {
            this.parent = parent;

            this.context = new MainContext();

            this.element = component(parent, { style: "color: blue;" },
                body(
                    div({
                        style: "position: relative;"
                    },
                        component("h1", { innerText: () => "No no no" }, "Hello World!", "World World!"),
                        inputText({
                            value: () => this.context.tags,
                            onchange: (e) => {
                                this.context.tags = e.target.value;
                                this.update();
                            },
                            onkeyup: (e) => {
                                this.context.tags = e.target.value;
                                this.update();
                            }
                        }),
                        "input completed!",
                        () => "Hey lambda!",
                        listComponent({
                            data: () => this.context.tags.split(" ").filter(t => t),
                            createElement: (tag) => {
                                return element("div", {
                                    style: `color: ${tag};`,
                                    innerText: tag + " "
                                });
                            }
                        })
                    ),
                    (() => {
                        let mycontext = {
                            items1: ["List 1", "Item 1", "Item 2", "Item 3"],
                            items2: ["List 2", "Item 1", "Item 2", "Item 3"],
                            items3: ["List 3", "Item 1", "Item 2", "Item 3"]
                        };
                        let el = body(
                            button({
                                innerText: "Add to list 1",
                                onclick: () => {
                                    mycontext.items1.push(
                                        mycontext.items1.length === 0 ?
                                            `List 1` :
                                            `Item ${mycontext.items1.length}`);
                                    this.update();
                                }
                            }),
                            button({
                                innerText: "Add to list 2",
                                onclick: () => {
                                    mycontext.items2.push(
                                        mycontext.items2.length === 0 ?
                                            `List 2` :
                                            `Item ${mycontext.items2.length}`);
                                    this.update();
                                }
                            }),
                            button({
                                innerText: "Add to list 3",
                                onclick: () => {
                                    mycontext.items3.push(
                                        mycontext.items3.length === 0 ?
                                            `List 3` :
                                            `Item ${mycontext.items3.length}`);
                                    this.update();
                                }
                            }),
                            list({
                                data: () => mycontext.items1,
                                createElement: (d) => body(div({
                                    innerText: d
                                }),
                                    button({
                                        innerText: `remove ${d}`,
                                        onclick: () => {
                                            mycontext.items1.splice(mycontext.items1.indexOf(d), 1);
                                            this.update();
                                        }
                                    })
                                )
                            }),
                            list({
                                data: () => mycontext.items2,
                                createElement: (d) => body(div({
                                    innerText: d
                                }),
                                    button({
                                        innerText: `remove ${d}`,
                                        onclick: () => {
                                            mycontext.items2.splice(mycontext.items2.indexOf(d), 1);
                                            this.update();
                                        }
                                    })
                                )
                            }),

                            list({
                                data: () => mycontext.items3,
                                createElement: (d) => body(div({
                                    innerText: d
                                }),
                                    button({
                                        innerText: `remove ${d}`,
                                        onclick: () => {
                                            mycontext.items3.splice(mycontext.items3.indexOf(d), 1);
                                            this.update();
                                        }
                                    })
                                )
                            }),
                        );

                        return el;
                    })()
                    ,
                    div({ id: 1 },
                        listComponent({
                            data: () => this.context.items,
                            createElement: (data) => {
                                return div({
                                    innerText: data,
                                    setState: function (s) {
                                        this.innerText = s;
                                    }
                                });
                            }
                        })),
                    button({
                        className: () => `clickable ${this.context.buttonClicked ? "clicked" : null}`,
                        innerText: () => !this.context.buttonClicked ? "Click me!" : "Click again!",
                        onclick: (e) => {
                            this.context.buttonClicked = true;
                            if (Math.random() > .5) {
                                this.context.items.splice(0, 1);
                            }
                            else {
                                this.context.items.splice(
                                    Math.round(Math.random() * (this.context.items.length - 1)),
                                    0, Math.round(Math.random() * 30));
                            }
                            this.context.count += 1;
                            this.update();
                        }
                    }),
                    div({
                        innerText: () => this.context.count
                    }),
                    div({

                    },
                        inputText({
                            placeholder: "enter something"
                        }),
                        button({
                            innerText: "add",
                            onclick: (e) => {
                                this.context.leftright.push({
                                    value: e.target.parentElement.querySelector("input").value,
                                    side: false
                                });
                                this.update();
                            }
                        })

                    ),
                    div({
                        style: "display: flex;"
                    },
                        div({
                            style: "width: 300px;"
                        },
                            component("h3", {
                                innerText: "left side"
                            }),
                            listComponent({
                                data: () => this.context.leftright.filter(e => e.side),
                                createElement: (d) => body(
                                    div({
                                        innerText: () => d.value
                                    }),
                                    inputText({
                                        placeholder: "rename",
                                        onkeydown: (e) => {
                                            if (e.keyCode === 13) {
                                                d.value = e.target.value;
                                                this.update();
                                            }
                                        }
                                    }),
                                    button({
                                        innerText: "to the right",
                                        onclick: () => {
                                            d.side = !d.side;
                                            this.update();
                                        }
                                    }))
                            })
                        ),
                        div({
                            style: "width: 300px;"
                        },
                            component("h3", {
                                innerText: "right side"
                            }),
                            listComponent({
                                data: () => this.context.leftright.filter(e => !e.side),
                                createElement: (d) => body(
                                    div({
                                        innerText: d.value
                                    }),
                                    button({
                                        innerText: "to the left",
                                        onclick: () => {
                                            d.side = !d.side;
                                            this.update();
                                        }
                                    }))
                            })
                        ),
                        button({
                            innerText: "resort",
                            onclick: () => {
                                this.context.leftright = this.context.leftright.reverse();
                                this.update();
                            }
                        })
                    ),
                    div({
                        style: "border: solid 1px red"
                    },
                        switchComponent({
                            items: [
                                {
                                    active: () => this.context.count % 2 === 0,
                                    createElement: () => contentPage({

                                    })
                                },
                                {
                                    active: () => this.context.count % 2 === 1,
                                    createElement: () => itemPage({

                                    })
                                }
                            ]
                        })
                    )
                )
            );
        }

        update() {
            this.element.update();
        }
    }

    main = new MainApp(document.body);
    main.update();
</script>
<!--
<script>
    function bind(state) {

        return {

        };
    }

    function htmlElement(tag, attrs, children) {
        let e = document.createElement(tag);
        Object.keys(attrs).forEach(k => {
            if (k.startsWith("on")) {
                e[k] = attrs[k];
            }
            else {
                e.setAttribute(k, attrs[k]);
            }
        })

        if (children.length > 0) {
            e.append(children[0]);
        }

        return e;
    }
    function div(attrs, children) {
        return htmlElement("div", attrs, children);
    }
    function myButton(attrs) {
        let count = 0;

        return div({

        }, ["Click Me!"]);
    }
    document.body.append(
        div({
            onclick: () => console.log("Her!!!")
        }, [
            div({}, ["Hey!"])
        ]));

    document.onload = () => { console.log("loaded!"); };
    function updateAsync(element, update) {
        let promise = new Promise((resolve, reject) => {
            let observer = new MutationObserver((ms) => {
                mutation = ms.filter(m => {
                    for (let i = 0; i < m.removedNodes.length; ++i) {
                        let node = m.removedNodes.item(i);
                        if (node === element)
                            return true;
                    }

                    return false;
                })[0];
                if (mutation) {
                    resolve(mutation.addedNodes.item(1))
                    observer.disconnect();
                }
            })
            observer.observe(document, {
                'childList': true, 'attributes': false, 'characterData': false, 'subtree': true
            });

            update(element);
        });

        return promise;
    }

    document.querySelectorAll("script[type='text/html'][id]")
        .forEach(e => {
            document.querySelectorAll(`${e.id}`).forEach(async c => {
                console.log(e);
                let nc = await updateAsync(c, () => {
                    c.outerHTML = e.innerHTML;
                });

                nc.querySelectorAll("script").forEach(s => {
                    console.log(s);
                    let out = null;
                    eval(s.innerHTML);

                    s.after(out);
                })
            });
        });

    var context = {
        value: 0,


    };
    window.onpopstate = () => {
        console.log(context.value);
    };

    let logElement = document.querySelector("#log");

    Object.keys(window).forEach(k => {
        if (k.startsWith("on") &&
            !k.startsWith("onmouse") &&
            !k.startsWith("onpointer") &&
            !k.startsWith("onbeforeunload") &&
            !k.startsWith("onunload")) {
            window[k] = (e) => {
                let log = document.createElement("div");
                log.innerText = e;
                logElement.prepend(log);
                console.log(e);
            };
        }
    });

    function buttonClick(event) {
        history.pushState({
            value: 1
        },
            null,
            "/pushed");
    }

    function incrementClick() {
        context.value += 1;

        console.log(context.value);
    }
</script>
-->